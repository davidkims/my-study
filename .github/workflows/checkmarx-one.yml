name: Secure Spring Boot Build with Checkmarx

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  build-and-scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Install PostgreSQL client (for local SQL server integration)
      run: sudo apt-get update && sudo apt-get install -y postgresql-client

    - name: Create project folders
      run: |
        mkdir -p springboot-app/src/main/java/com/example/demo
        mkdir -p sql/init
        mkdir -p reports/checkmarx
        echo "✅ 폴더 생성 완료"

    - name: Initialize sample pom.xml and SQL file
      run: |
        cat <<EOF > springboot-app/pom.xml
        <project xmlns="http://maven.apache.org/POM/4.0.0" ...>
          <modelVersion>4.0.0</modelVersion>
          <groupId>com.example</groupId>
          <artifactId>demo</artifactId>
          <version>0.0.1-SNAPSHOT</version>
          <dependencies>
            <dependency>
              <groupId>org.springframework.boot</groupId>
              <artifactId>spring-boot-starter-web</artifactId>
            </dependency>
          </dependencies>
        </project>
        EOF

        echo "CREATE TABLE test (id INT PRIMARY KEY);" > sql/init/schema.sql

    - name: Build Spring Boot with Maven
      run: |
        cd springboot-app
        mvn clean install

    - name: Run Checkmarx One scan
      uses: checkmarx/ast-github-action@8e887bb93dacc44e0f5b64ee2b06d5815f89d4fc
      with:
        base_uri: https://ast.checkmarx.net
        cx_client_id: ${{ secrets.CX_CLIENT_ID }}
        cx_client_secret: ${{ secrets.CX_CLIENT_SECRET }}
        cx_tenant: ${{ secrets.CX_TENANT }}
        additional_params: --report-format sarif --output-path reports/checkmarx

    - name: Upload SARIF report
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: reports/checkmarx/cx_result.sarif
