name: Datadog CI with Auto API Key Handling

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  DATADOG_API_HOST: https://api.datadoghq.com
  NEW_KEY_NAME: "ci-synthetic-key-${{ github.run_id }}"

jobs:
  datadog-test:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ðŸ› ï¸ Install jq for JSON parsing
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: ðŸ” Generate Datadog API Key or Fallback
      id: generate_key
      run: |
        echo "â–¶ï¸ Datadog API Key ìƒì„± ì‹œë„..."

        response=$(curl -s -X POST "${DATADOG_API_HOST}/api/v1/api_key" \
          -H "Content-Type: application/json" \
          -H "DD-API-KEY: ${{ secrets.ADMIN_DD_API_KEY }}" \
          -H "DD-APPLICATION-KEY: ${{ secrets.ADMIN_DD_APP_KEY }}" \
          -d "{\"name\": \"${NEW_KEY_NAME}\"}")

        api_key=$(echo "$response" | jq -r '.api_key')

        if [[ "$api_key" != "null" && "$api_key" != "" ]]; then
          echo "âœ… API í‚¤ ìƒì„± ì„±ê³µ: $api_key"
          echo "::add-mask::$api_key"
          echo "API_KEY=${api_key}" >> $GITHUB_ENV
        else
          echo "âŒ ìƒì„± ì‹¤íŒ¨, ë°±ì—… í‚¤ ë‹¤ìš´ë¡œë“œ ì‹œë„..."
          curl -sSL -o dd_key_backup.json "https://example.com/backup/dd_key_backup.json"
          backup_key=$(cat dd_key_backup.json | jq -r '.api_key')

          if [[ "$backup_key" != "null" && "$backup_key" != "" ]]; then
            echo "âœ… ë°±ì—… í‚¤ ë‹¤ìš´ë¡œë“œ ì„±ê³µ"
            echo "::add-mask::$backup_key"
            echo "API_KEY=${backup_key}" >> $GITHUB_ENV
          else
            echo "ðŸš¨ ë°±ì—… í‚¤ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨, ì¢…ë£Œ"
            exit 1
          fi
        fi

    - name: ðŸ§ª Run Datadog Synthetic Tests
      uses: DataDog/synthetics-ci-github-action@v1.4.0
      with:
        api_key: ${{ env.API_KEY }}
        app_key: ${{ secrets.ADMIN_DD_APP_KEY }}
        test_search_query: 'tag:e2e-tests'
        tunnel: false

    - name: âœ… Done
      run: echo "ðŸŽ‰ Datadog Synthetic í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
