name: Full GitHub Pages Automation with Server & Disk Setup

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: Create server directories and permissions
        run: |
          echo "ğŸ“ Creating server folders..."
          mkdir -p ~/my-app/{logs,bin,config,tmp}
          chmod -R 755 ~/my-app
          echo "âœ… ~/my-app structure created"

      - name: Create disk slot structure
        run: |
          TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
          SLOT_DIR=".disk-slots/slot-${TIMESTAMP}"
          mkdir -p "${SLOT_DIR}"/{build,config,public,logs}
          echo "SLOT_DIR=${SLOT_DIR}" >> $GITHUB_ENV
          echo "âœ… Created disk slot: ${SLOT_DIR}"

      - name: Install base packages
        run: |
          echo "ğŸ“¦ Installing required packages..."
          sudo apt-get update
          sudo apt-get install -y curl unzip tree
          echo "âœ… Packages installed"

      - name: Generate ìê¸°ì†Œê°œ í˜ì´ì§€ (index.md)
        run: |
          cat <<EOF > index.md
          ---
          layout: default
          title: "ìê¸°ì†Œê°œì„œ"
          ---

          # ğŸ‘¤ ìê¸°ì†Œê°œì„œ

          ì•ˆë…•í•˜ì„¸ìš”. ì €ëŠ” ì—´ì •ì ì¸ ê°œë°œì **ê¹€ë³‘ê¶Œ**ì…ë‹ˆë‹¤.

          ## âœ… ì£¼ìš” ê¸°ìˆ 
          - Python, Java, Spring Boot
          - GitHub Actions, Docker, AWS
          - ë³´ì•ˆ ì¸ì¦ (ISMS-P, CC ë“±)

          ## ğŸ’¼ ìë™í™” êµ¬ì„± ìš”ì†Œ
          - ì„œë²„ ë””ë ‰í† ë¦¬ ìƒì„±: ~/my-app/
          - ë””ìŠ¤í¬ ìŠ¬ë¡¯: \`${{ env.SLOT_DIR }}\`
          - GitHub Pages ìë™ ë°°í¬

          ## ğŸ—‚ï¸ êµ¬ì¡°
          \`\`\`bash
          ~/my-app/
          â”œâ”€â”€ logs/
          â”œâ”€â”€ bin/
          â”œâ”€â”€ config/
          â””â”€â”€ tmp/

          .disk-slots/
          â””â”€â”€ slot-<timestamp>/
              â”œâ”€â”€ build/
              â”œâ”€â”€ config/
              â”œâ”€â”€ public/
              â””â”€â”€ logs/
          \`\`\`

          > ê°ì‚¬í•©ë‹ˆë‹¤.
          EOF

      - name: Generate _config.yml
        run: |
          cat <<EOF > _config.yml
          title: ê¹€ë³‘ê¶Œì˜ ìë™í™” í˜ì´ì§€
          description: GitHub Actions + Jekyll + Server Infra
          theme: minima
          EOF

      - name: Build Jekyll site
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
