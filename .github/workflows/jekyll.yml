name: Full GitHub Pages Deploy with Backend, Logs, and Reports

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: Create server and disk directories
        run: |
          mkdir -p ~/my-app/{logs,bin,config,tmp}
          TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
          SLOT_DIR=".disk-slots/slot-${TIMESTAMP}"
          mkdir -p "${SLOT_DIR}"/{build,config,public,logs}
          echo "SLOT_DIR=${SLOT_DIR}" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl unzip tree python3 python3-pip openjdk-17-jdk
          pip3 install fastapi uvicorn

      - name: Start FastAPI Server
        run: |
          echo 'from fastapi import FastAPI
app = FastAPI()
@app.get("/health")
def read_root(): return {"status": "ok"}' > app.py
          nohup uvicorn app:app --host 0.0.0.0 --port 8000 & echo $! > uvicorn.pid
          sleep 3
          curl -f http://localhost:8000/health || (echo "âŒ FastAPI failed" && exit 1)

      - name: Generate ISMS-P security logs
        run: |
          mkdir -p logs
          echo "[AUDIT] $(date) - Admin accessed /settings" >> logs/audit.log
          echo "[ACCESS] $(date) - User login from IP 192.168.0.1" >> logs/access.log
          echo "[REPORT] $(date) - Report generated for slot $SLOT_DIR" >> ${SLOT_DIR}/logs/report.log
          tar -czf ${SLOT_DIR}/logs/isms-p-logs.tar.gz logs/

      - name: Generate index.md
        run: |
          cat <<EOF > index.md
          ---
          layout: default
          title: "ìê¸°ì†Œê°œì„œ"
          ---

          # ğŸ‘¤ ìê¸°ì†Œê°œì„œ

          ì•ˆë…•í•˜ì„¸ìš”. ì €ëŠ” ì—´ì •ì ì¸ ê°œë°œì **ê¹€ë³‘ê¶Œ**ì…ë‹ˆë‹¤.

          ## ğŸ”Œ ì‹œìŠ¤í…œ í†µí•© êµ¬ì„±
          - FastAPI ë°±ì—”ë“œ â†’ [í—¬ìŠ¤ì²´í¬](http://localhost:8000/health)
          - ë””ìŠ¤í¬ ìŠ¬ë¡¯: \`${{ env.SLOT_DIR }}\`
          - ë³´ì•ˆ ë¡œê·¸: audit.log, access.log
          - ìë™ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ

          ## ğŸ“‚ êµ¬ì¡°
          \`\`\`bash
          ~/my-app/
          â”œâ”€â”€ logs/
          â”œâ”€â”€ bin/
          â””â”€â”€ config/

          .disk-slots/
          â””â”€â”€ slot-<timestamp>/
              â”œâ”€â”€ build/
              â”œâ”€â”€ logs/
              â”‚   â”œâ”€â”€ report.log
              â”‚   â””â”€â”€ isms-p-logs.tar.gz
              â””â”€â”€ public/
          \`\`\`

          > ëª¨ë“  ê³¼ì •ì€ ìë™í™”ë©ë‹ˆë‹¤.
          EOF

      - name: Generate _config.yml
        run: |
          cat <<EOF > _config.yml
          title: ê¹€ë³‘ê¶Œ ìë™í™” í˜ì´ì§€
          description: Backend + Log + Slot + GitHub Pages í†µí•©
          theme: minima
          include:
            - .disk-slots
            - .github
          EOF

      - name: Copy .github/workflows and reports
        run: |
          mkdir -p ./_site/github/workflows
          cp -r .github/workflows/* ./_site/github/workflows/
          mkdir -p ./_site/reports
          cp -r ${SLOT_DIR}/logs/* ./_site/reports/

      - name: Build Jekyll site
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
