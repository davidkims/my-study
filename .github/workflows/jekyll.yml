name: Full Auto Deploy to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # ğŸ“¦ 1. ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # âš™ï¸ 2. GitHub Pages REST APIë¡œ ê°•ì œ í™œì„±í™”
      - name: Enable GitHub Pages via API
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        run: |
          echo "ğŸ”§ Enabling GitHub Pages via API..."
          curl -L -X PUT \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/repos/$OWNER/$REPO/pages \
            -d '{"build_type":"workflow"}'

      # âš™ï¸ 3. GitHub Pages ì„¤ì •
      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      # ğŸ“ 4. ë””ë ‰í† ë¦¬/ì„œë²„ ì´ˆê¸°í™” + ê¶Œí•œ ì„¤ì •
      - name: Setup Server Folders and Permissions
        run: |
          echo "ğŸ“ Creating server directories..."
          mkdir -p ~/my-app/logs
          mkdir -p ~/my-app/bin
          mkdir -p ~/my-app/config
          chmod -R 755 ~/my-app
          echo "âœ… Server structure ready"

      # ğŸ’½ 5. ë””ìŠ¤í¬ ìŠ¬ë¡¯ ê¸°ë°˜ ë¦¬ì†ŒìŠ¤ í´ë” ìë™ ìƒì„±
      - name: Create Disk Slot Structure
        run: |
          TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
          SLOT_DIR=".disk-slots/slot-${TIMESTAMP}"
          mkdir -p "${SLOT_DIR}/build"
          mkdir -p "${SLOT_DIR}/config"
          mkdir -p "${SLOT_DIR}/public"
          echo "SLOT_DIR=${SLOT_DIR}" >> $GITHUB_ENV
          echo "âœ… Created disk slot: $SLOT_DIR"

      # ğŸ”§ 6. ê¸°ë³¸ í”„ë¡œê·¸ë¨ ì„¤ì¹˜ (ì˜ˆ: unzip, curl ë“±)
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl unzip tree
          echo "âœ… Dependencies installed"

      # ğŸ“„ 7. ìê¸°ì†Œê°œ í˜ì´ì§€ ìƒì„±
      - name: Generate index.md
        run: |
          cat <<EOF > index.md
          ---
          layout: default
          title: "ìê¸°ì†Œê°œì„œ"
          ---

          # ğŸ‘¤ ìê¸°ì†Œê°œì„œ

          ì•ˆë…•í•˜ì„¸ìš”. ì €ëŠ” ì—´ì •ì ì¸ ê°œë°œì **ê¹€ë³‘ê¶Œ**ì…ë‹ˆë‹¤.  
          ìë™í™”, í´ë¼ìš°ë“œ, ë³´ì•ˆ, ì„±ëŠ¥ ìµœì í™”ì— ì§‘ì¤‘í•©ë‹ˆë‹¤.

          ## ì£¼ìš” ê¸°ìˆ 
          - Python, Java, Spring Boot
          - GitHub Actions, Docker, AWS
          - ë³´ì•ˆ ì¸ì¦ (ISMS-P, CC)

          ## ë””ìŠ¤í¬ ìŠ¬ë¡¯ ê´€ë¦¬ ì‹œìŠ¤í…œ
          í˜„ì¬ ì‹¤í–‰ ìŠ¬ë¡¯: \`${{ env.SLOT_DIR }}\`

          ## ì„œë²„ êµ¬ì¡°
          \`\`\`bash
          ~/my-app/
          â”œâ”€â”€ logs/
          â”œâ”€â”€ bin/
          â””â”€â”€ config/
          \`\`\`

          > ëª¨ë“  ë¦¬ì†ŒìŠ¤ëŠ” ìë™ ìƒì„± ë° ë°°í¬ë©ë‹ˆë‹¤.
          EOF

      # ğŸ“„ 8. Jekyll ì„¤ì • íŒŒì¼
      - name: Generate _config.yml
        run: |
          cat <<EOF > _config.yml
          title: ê¹€ë³‘ê¶Œì˜ í™ˆí˜ì´ì§€
          description: Jekyll + GitHub Actions ìë™ ë°°í¬ ì‹œìŠ¤í…œ
          theme: minima
          EOF

      # ğŸ› ï¸ 9. Jekyll Build
      - name: Build site
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      # ğŸ“¦ 10. GitHub Pages ì—…ë¡œë“œ ì¤€ë¹„
      - name: Upload site artifact
        uses: actions/upload-pages-artifact@v3

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
