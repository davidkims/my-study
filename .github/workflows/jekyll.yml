name: Full GitHub Pages Deploy with Disk & Workflow Exposure

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: Create server directories and permissions
        run: |
          mkdir -p ~/my-app/{logs,bin,config,tmp}
          chmod -R 755 ~/my-app

      - name: Create disk slot structure
        run: |
          TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
          SLOT_DIR=".disk-slots/slot-${TIMESTAMP}"
          mkdir -p "${SLOT_DIR}"/{build,config,public,logs}
          echo "SLOT_DIR=${SLOT_DIR}" >> $GITHUB_ENV

      - name: Install base packages
        run: |
          sudo apt-get update
          sudo apt-get install -y curl unzip tree

      - name: Generate index.md
        run: |
          cat <<EOF > index.md
          ---
          layout: default
          title: "ìê¸°ì†Œê°œì„œ"
          ---

          # ğŸ‘¤ ìê¸°ì†Œê°œì„œ

          ì•ˆë…•í•˜ì„¸ìš”. ì €ëŠ” ì—´ì •ì ì¸ ê°œë°œì **ê¹€ë³‘ê¶Œ**ì…ë‹ˆë‹¤.

          ## âœ… ì£¼ìš” ê¸°ìˆ 
          - Python, Java, Spring Boot
          - GitHub Actions, Docker, AWS
          - ë³´ì•ˆ ì¸ì¦ (ISMS-P, CC ë“±)

          ## ğŸ’¼ ìë™í™” êµ¬ì„± ìš”ì†Œ
          - ì„œë²„ ë””ë ‰í† ë¦¬: ~/my-app/
          - ë””ìŠ¤í¬ ìŠ¬ë¡¯: \`${{ env.SLOT_DIR }}\`
          - Workflows ë…¸ì¶œ: [ë³´ê¸°](/github/workflows/)

          > ê°ì‚¬í•©ë‹ˆë‹¤.
          EOF

      - name: Generate _config.yml
        run: |
          cat <<EOF > _config.yml
          title: ê¹€ë³‘ê¶Œì˜ ìë™í™” í˜ì´ì§€
          description: GitHub Actions + Jekyll + Server Infra
          theme: minima
          include:
            - .github
          EOF

      # âœ… .github/workflows ë””ë ‰í† ë¦¬ë¥¼ _site/ í•˜ìœ„ë¡œ ë³µì‚¬
      - name: Copy .github/workflows for page publishing
        run: |
          mkdir -p ./_site/github/workflows
          cp -r .github/workflows/* ./_site/github/workflows/
          echo "âœ… Copied .github/workflows to _site/"

      - name: Build Jekyll site
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
