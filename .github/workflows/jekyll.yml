name: Deploy Jekyll Personal Page with Pages Auto-Enablement

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # GitHub Pages 자동 활성화 (build_type: workflow)
      - name: Enable GitHub Pages via REST API
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        run: |
          echo "🔧 Activating GitHub Pages..."
          curl -L -X PUT \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/repos/$OWNER/$REPO/pages \
            -d '{"build_type":"workflow"}'

      # 오류 원인이던 잘못된 token, enablement 제거
      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: Generate 자기소개 페이지 (index.md)
        run: |
          cat <<EOF > index.md
          ---
          layout: default
          title: "자기소개서"
          ---

          # 👤 자기소개서

          안녕하세요. 저는 열정적인 개발자 **김병권**입니다.  
          다양한 기술 스택을 활용해 자동화와 성능 최적화에 집중합니다.

          ## 📌 주요 기술
          - Python, Java, Spring Boot
          - GitHub Actions, Docker, AWS
          - 보안 인증 (ISMS-P, CC 등)

          ## 💼 프로젝트 경험
          - ✅ GitHub Actions 기반 자동 배포 구축
          - ✅ Flask → FastAPI 전환 및 최적화
          - ✅ Datadog, Checkmarx 통합 자동화 구성

          ## 🎯 목표
          지속적인 학습과 성장을 통해 더 나은 솔루션을 설계하고 구현하는 개발자가 되겠습니다.

          > 감사합니다!
          EOF

      - name: Generate Jekyll config (_config.yml)
        run: |
          cat <<EOF > _config.yml
          title: 김병권의 자기소개 페이지
          description: GitHub Actions + Jekyll + Pages 자동화 예제
          theme: minima
          EOF

      - name: Build Jekyll site
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      - name: Upload site artifact
        uses: actions/upload-pages-artifact@v3

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
