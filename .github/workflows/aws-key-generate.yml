name: Secure AWS OIDC Setup and IAM Key Generation

on:
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  AWS_ACCOUNT_ID: "123456789012"               # â† ë³¸ì¸ AWS ê³„ì • ID
  ROLE_NAME: github-actions-oidc-role
  IAM_USER_NAME: github-deploy-user
  REPO_NAME: davidkims/my-repo

jobs:
  check-for-paid-resources:
    name: Step 0 - ê²°ì œ ìœ ë°œ ì„œë¹„ìŠ¤ í™•ì¸
    runs-on: ubuntu-latest
    steps:
    - name: Install AWS CLI
      run: |
        sudo apt-get update
        sudo apt-get install -y jq
        pip install awscli

    - name: Authenticate with access keys
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Check for paid resources
      run: |
        echo "ğŸ” Checking for active EC2 instances..."
        EC2_RUNNING=$(aws ec2 describe-instances --query "Reservations[*].Instances[*].State.Name" --output text | grep running || true)

        echo "ğŸ” Checking for active RDS instances..."
        RDS_RUNNING=$(aws rds describe-db-instances --query "DBInstances[*].DBInstanceStatus" --output text | grep available || true)

        echo "ğŸ” Checking for active CloudRun services..."
        RUN_SERVICES=$(aws run list-services --region $AWS_REGION --output text || true)

        if [[ -n "$EC2_RUNNING" || -n "$RDS_RUNNING" || -n "$RUN_SERVICES" ]]; then
          echo "âŒ ê²°ì œ ìœ ë°œ ê°€ëŠ¥ì„±ì´ ìˆëŠ” ë¦¬ì†ŒìŠ¤ê°€ ì¡´ì¬í•©ë‹ˆë‹¤. ì‹¤í–‰ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
          exit 1
        fi

        echo "âœ… ê³¼ê¸ˆ ìœ ë°œ ë¦¬ì†ŒìŠ¤ ì—†ìŒ. ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤."

  setup-oidc-role:
    name: Step 1 - OIDC ê³µê¸‰ì ë° IAM ì—­í•  ìƒì„±
    needs: check-for-paid-resources
    runs-on: ubuntu-latest

    steps:
    - name: Install AWS CLI
      run: |
        sudo apt-get update
        sudo apt-get install -y jq
        pip install awscli

    - name: Authenticate to AWS (Access Keys)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Create OIDC Provider and IAM Role
      run: |
        echo "ğŸ“Œ Checking OIDC provider..."
        OIDC_EXISTS=$(aws iam list-open-id-connect-providers | grep token.actions.githubusercontent.com || true)

        if [ -z "$OIDC_EXISTS" ]; then
          echo "âœ… Creating OIDC provider..."
          aws iam create-open-id-connect-provider \
            --url https://token.actions.githubusercontent.com \
            --client-id-list sts.amazonaws.com \
            --thumbprint-list 6938fd4d98bab03faadb97b34396831e3780aea1
        else
          echo "âœ… OIDC provider already exists."
        fi

        echo "ğŸ“Œ Creating IAM role..."
        TRUST_POLICY=$(cat <<EOF
        {
          "Version": "2012-10-17",
          "Statement": [{
            "Effect": "Allow",
            "Principal": {
              "Federated": "arn:aws:iam::${AWS_ACCOUNT_ID}:oidc-provider/token.actions.githubusercontent.com"
            },
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Condition": {
              "StringLike": {
                "token.actions.githubusercontent.com:sub": "repo:${REPO_NAME}:*"
              },
              "StringEquals": {
                "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
              }
            }
          }]
        }
        EOF
        )

        aws iam create-role --role-name "${ROLE_NAME}" --assume-role-policy-document "$TRUST_POLICY" || echo "â„¹ï¸ Role already exists."

        echo "ğŸ“Œ Attaching inline policy to role..."
        POLICY=$(cat <<EOF
        {
          "Version": "2012-10-17",
          "Statement": [{
            "Effect": "Allow",
            "Action": [
              "iam:CreateAccessKey",
              "iam:ListAccessKeys",
              "iam:GetUser",
              "iam:DeleteAccessKey"
            ],
            "Resource": "arn:aws:iam::${AWS_ACCOUNT_ID}:user/${IAM_USER_NAME}"
          }]
        }
        EOF
        )

        aws iam put-role-policy \
          --role-name "${ROLE_NAME}" \
          --policy-name allow-access-key \
          --policy-document "$POLICY"

  create-access-key:
    name: Step 2 - OIDC ì¸ì¦ í›„ í‚¤ ìƒì„± ë° ë¡œê·¸ ì €ì¥
    needs: setup-oidc-role
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install AWS CLI and jq
      run: |
        sudo apt-get update
        sudo apt-get install -y jq
        pip install awscli

    - name: Authenticate with OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/${{ env.ROLE_NAME }}
        aws-region: ${{ env.AWS_REGION }}
        audience: sts.amazonaws.com

    - name: Create Access Key for IAM User
      run: |
        ACCESS_KEY_JSON=$(aws iam create-access-key --user-name $IAM_USER_NAME)
        echo "$ACCESS_KEY_JSON" > .github/workflows/key-log.log

        ACCESS_KEY_ID=$(echo "$ACCESS_KEY_JSON" | jq -r .AccessKey.AccessKeyId)
        SECRET_KEY=$(echo "$ACCESS_KEY_JSON" | jq -r .AccessKey.SecretAccessKey)

        echo "ğŸªª AccessKeyId: $ACCESS_KEY_ID"
        echo "ğŸ” SecretAccessKey: $SECRET_KEY"

    - name: Commit key log
      run: |
        git config user.name "github-actions"
        git config user.email "actions@github.com"
        git add .github/workflows/key-log.log
        git commit -m "ğŸ” IAM Access Key Generated"
        git push
