name: AWS Key Generator

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: write

jobs:
  generate-aws-key:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install AWS CLI and jq
      run: |
        sudo apt-get update
        sudo apt-get install -y jq
        python3 -m pip install --upgrade pip
        pip install awscli

    - name: Configure AWS CLI via GitHub OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::<AWS_ACCOUNT_ID>:role/<ROLE_NAME>  # ← 수정
        aws-region: ap-northeast-2

    - name: Create AWS Access Key
      id: create_key
      run: |
        echo "🔐 Creating new AWS Access Key..."
        ACCESS_KEY_JSON=$(aws iam create-access-key --user-name github-deploy-user)

        echo "$ACCESS_KEY_JSON" > .github/workflows/key-log.log

        echo "✅ Access Key Created."
        echo "ACCESS_KEY_ID=$(echo $ACCESS_KEY_JSON | jq -r .AccessKey.AccessKeyId)" >> $GITHUB_ENV
        echo "SECRET_ACCESS_KEY=$(echo $ACCESS_KEY_JSON | jq -r .AccessKey.SecretAccessKey)" >> $GITHUB_ENV

    - name: Show Access Key (for debug - remove in production)
      run: |
        echo "🪪 AccessKeyId: $ACCESS_KEY_ID"
        echo "🕶 SecretAccessKey: $SECRET_ACCESS_KEY"
        echo "📝 Log saved to: .github/workflows/key-log.log"

    - name: Commit Key Log
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "actions@github.com"
        git add .github/workflows/key-log.log
        git commit -m "🔐 AWS Access Key created and logged"
        git push
