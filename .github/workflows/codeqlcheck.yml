name: Re-run Failed Workflows (Auto Retry)

on:
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  rerun-failed:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Fetch last 100 workflow runs
        run: |
          echo "📥 Fetching workflow runs..."
          curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github+json" \
               "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=100" \
               -o runs.json

          echo "✅ Saved to runs.json"
          cat runs.json | jq '.workflow_runs[] | {id, name, conclusion, html_url}' > filtered.json

      - name: List failed workflows
        id: list_failed
        run: |
          echo "🔍 Identifying failed runs..."
          FAILED_IDS=$(jq -r 'select(.conclusion == "failure") | .id' filtered.json)

          if [ -z "$FAILED_IDS" ]; then
            echo "✅ No failed runs to re-run."
            echo "has_failures=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "$FAILED_IDS" > failed_ids.txt
          echo "has_failures=true" >> $GITHUB_OUTPUT

          echo "❗ Failed Run IDs:"
          cat failed_ids.txt

      - name: Re-run failed workflows
        if: steps.list_failed.outputs.has_failures == 'true'
        run: |
          echo "🔁 Re-running failed workflows..."
          while read -r ID; do
            echo "🔁 Re-running run ID: $ID"
            curl -s -X POST \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs/${ID}/rerun"

            echo "🕒 Waiting briefly between reruns..."
            sleep 2
          done < failed_ids.txt

          echo "✅ All failed workflows re-triggered."
