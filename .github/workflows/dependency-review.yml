name: Hourly Vulnerability Snapshot with OSV Scanner

on:
  schedule:
    - cron: '0 * * * *'  # Îß§ ÏãúÍ∞Ñ Ï†ïÍ∞Å Ïã§Ìñâ
  workflow_dispatch:

permissions:
  contents: read

jobs:
  osv-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create Snapshot Directory
        id: snapshot
        run: |
          TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
          SNAPSHOT_DIR=".security-snapshots/slot-${TIMESTAMP}"
          mkdir -p "$SNAPSHOT_DIR"
          echo "SNAPSHOT_DIR=$SNAPSHOT_DIR" >> $GITHUB_ENV
          echo "üì∏ Snapshot path: $SNAPSHOT_DIR"

      - name: Install OSV Scanner (v1.6.2 from tar.gz)
        run: |
          curl -sSL https://github.com/google/osv-scanner/releases/download/v1.6.2/osv-scanner_1.6.2_linux_amd64.tar.gz -o osv.tar.gz
          tar -xzf osv.tar.gz
          chmod +x osv-scanner
          sudo mv osv-scanner /usr/local/bin/
          echo "‚úÖ OSV Scanner installed at $(which osv-scanner)"
          osv-scanner --version

      - name: Scan Python dependencies
        continue-on-error: true
        run: |
          if [ -f requirements.txt ]; then
            echo "üîç Scanning Python requirements.txt..."
            osv-scanner --lockfile=requirements.txt > "${SNAPSHOT_DIR}/osv-python.txt"
          else
            echo "‚ÑπÔ∏è No requirements.txt found"
          fi

      - name: Scan Java dependencies
        continue-on-error: true
        run: |
          if [ -f pom.xml ]; then
            echo "üîç Scanning Java pom.xml..."
            osv-scanner --lockfile=pom.xml > "${SNAPSHOT_DIR}/osv-java.txt"
          else
            echo "‚ÑπÔ∏è No pom.xml found"
          fi

      - name: Scan Node.js dependencies
        continue-on-error: true
        run: |
          if [ -f package-lock.json ]; then
            echo "üîç Scanning Node.js package-lock.json..."
            osv-scanner --lockfile=package-lock.json > "${SNAPSHOT_DIR}/osv-node.txt"
          else
            echo "‚ÑπÔ∏è No package-lock.json found"
          fi

      - name: Print Vulnerability Summary
        run: |
          echo "üìã Vulnerability Scan Summary:"
          for file in ${SNAPSHOT_DIR}/*.txt; do
            echo "--- $file ---"
            head -n 10 "$file" || echo "(empty)"
          done

      - name: Show Snapshot Tree
        run: |
          echo "üóÇ Snapshot Directory Tree:"
          tree .security-snapshots || echo "(tree not available)"
