name: Hourly Vulnerability Snapshot with OSV Scanner

on:
  schedule:
    - cron: '0 * * * *'  # ë§¤ì‹œê°„ ì‹¤í–‰
  workflow_dispatch:

permissions:
  contents: read

jobs:
  osv-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create Snapshot Directory
        id: snapshot
        run: |
          TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
          SNAPSHOT_DIR=".security-snapshots/slot-${TIMESTAMP}"
          mkdir -p "$SNAPSHOT_DIR"
          echo "SNAPSHOT_DIR=$SNAPSHOT_DIR" >> $GITHUB_ENV

      - name: Install OSV Scanner (v1.6.2 .deb)
        run: |
          curl -sSL https://github.com/google/osv-scanner/releases/download/v1.6.2/osv-scanner_1.6.2_linux_amd64.deb -o osv.deb
          sudo dpkg -i osv.deb
          echo "âœ… OSV Scanner installed at: $(which osv-scanner)"
          osv-scanner --version

      - name: Scan Python dependencies
        continue-on-error: true
        run: |
          if [ -f requirements.txt ]; then
            osv-scanner --lockfile=requirements.txt > "${SNAPSHOT_DIR}/osv-python.txt"
          fi

      - name: Scan Java dependencies
        continue-on-error: true
        run: |
          if [ -f pom.xml ]; then
            osv-scanner --lockfile=pom.xml > "${SNAPSHOT_DIR}/osv-java.txt"
          fi

      - name: Scan Node.js dependencies
        continue-on-error: true
        run: |
          if [ -f package-lock.json ]; then
            osv-scanner --lockfile=package-lock.json > "${SNAPSHOT_DIR}/osv-node.txt"
          fi

      - name: Print Summary
        run: |
          echo "ðŸ“‹ Scan Summary:"
          for file in ${SNAPSHOT_DIR}/*.txt; do
            echo "--- $file ---"
            head -n 10 "$file"
          done

      - name: Show Snapshot Tree
        run: |
          tree .security-snapshots || echo "No tree available"
